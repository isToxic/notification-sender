Сервис для отправки сообщений из интеграционной таблицы (Notification sender service)
=

Системные требования
-
- Java 8
- postgreSQL PostgreSQL 9.5.19

Инструкция по установке
- Порядок установки: 
1) Настройка переменных окружения
2) Миграция базы данных
3) Запуск приложения

- В архиве скрипт deploy.sh для запуска приложения в docker:
1) Установить значения переменных
 - port=9998 # порт приложения 
 - platform=postgres # тип базы данных (postgres и тд.)
 - db_address=172.17.0.4 # ip адрес базы данных
 - db_port=5432 # порт базы данных
 - db_name=notification-service # название базы
 - db_user=postgres # пользователь
 - db_pass="" # database пароль
 - sn_366_sms=dfgdfg # имя отправителя для 366 по sms
 - sn_366_push=dfgdfgdf # имя отправителя для 366 push
 - sn_gorzdrav_sms=dfgdfg # имя отправителя для gorzdrav по sms
 - sn_gorzdrav_push=dfgdfgdf # имя отправителя для gorzdrav push
 - send_url=http://www.send.to # url для отправки уведомлений
2) Сохранить и запустить скрпт: 
./deploy.sh

Если требуется установка без docker: 
1) заменить пунк сборки и установки контейнера в deploy.sh на 
java -jar -Xms256m -Xmx2048m build/libs/notification-sender-0.0.1-SNAPSHOT.jar
2) Сохранить и запустить deploy.sh

Описание работы
-
Данный сервис направлен на работу с интеграционной таблицей формата, описанного в миграции (db/migration).


Получение запросов на интеграцию
-
Каждые delay-millis миллисекунд Сервис выполняет запрос на получение списка задач на отправку уведомлений.

Критерии отбора сообщений: 
- Время создания сообщения меньше текущего не меньше, чем на wait-before-send-minutes минут.  
- Статус задания на интеграцию имеет значение 'NEW'
- Дата старта отправки наступила
- Дата конца отправки не наступила
- Выборка содержит n записей

Процесс обработки пакета сообщений
-
- Сервис проверяет пакет на наличие заданий
- 1) Задания есть: сервис проставляет статус processing, переход к следующему шагу
  2) Заданий нет: сервис ожидает следующий пакет сообщений
    
- Сервис выполняет запрос на получение списка заданий на деактивацию из таблицы
  
  Критерии отбора: 
  - Задача на деактивацию имеет статус 'NEW'
    
- Сервис отбирает запросы, где id из списка заданий на отправку равен id из списка заданий на деактивацию
- 1) Задания есть:
       - Сервис проставляет заданию на коммуниуацию статус 'ERROR'. Код и описание ошибки деактивации в БД
       - Сервис проставляет статус 'DONE' для задачи на деактивацию отправки
       - Сервис убирает из дальнейшей обработки данные записи
  2) Заданий нет: переход к следующему шагу
- Сообщения из пакета передаются на отправку в сервис отправки сообщений
- 1) Есть ошибка при отправке сообщения: Сервис проставляет заданию на коммуниуацию статус 'ERROR'. Код и описание ошибки в БД.
  2) Ошибки отсутствуют: Сервис проставляет заданию на коммуниуацию статус 'SENT' в БД.


Получение статуса интеграции
-
Сервис имеет REST контроллер для запросов метода POST.

Процесс обработки отчёта о доставке
-

- Сервис получает сообщение
- Сервис производит обработку отчёта о доставке:
  1) Ошибка есть: сервис обрабатывает сообщение с ответом, проставляет статус 'ERROR', данные по сообщению, код и
  описание ошибки в БД 
  2) Ошибка отсутствует: сервис обрабатывает сообщение с ответом, проставляет статус 'DELIVERED'
  или 'OPEN' в зависимости от данных отчёта, остальные данные по сообщению в БД

Настройки сервиса:
-
Настройки сервиса предоставлены в виде yaml файла.

###Пример и описание настроек
```yaml
notification:
  service-numbers:
    366:
      sms: 366 service number sms        // Сервисный номер для отправки смс вендора 36.6
      push: 366 service number push      // Сервисный номер для отправки пушей вендора 36.6
    gorzdrav:
      sms: gorzdrav service number sms   // Сервисный номер для отправки смс вендора 36.6
      push: gorzdrav service number push // Сервисный номер для отправки смс вендора 36.6
  send:
    url: http://mobicont.restapi         // Url для отправки сообщений
    connect-timeout-millis: 3000         // Таймаут подключения при отправке сообщений
    request-timeout-millis: 3000         // Таймаут запроса при отправке сообщений
    login: user login                    // Логин в системе адресата
    password: user password              // Пароль в системе адресата
    ttl: 60                              // Время жизни сообщения
    ttlUnit: MINUTES                     // Единицы измерения ttl
  receive:
    mapping: /status                     // Маппинг, по которому выставляется контроллер для получения статусов
    delay-millis: 30000                  // 
    wait-before-send-minutes: 30         // Время отсрочки отправки сообщения для возможности деактивации
    task-limit: 100                      // Колличество заданий на отправку в пакете
    core-pool-size: 10                   // Минимальное количество потоков, используемых пулом 
    max-pool-size: 10                    // Максимальный размер пула
    keep-alive-time: 20                  // Максимальное время выполнения обработки
```